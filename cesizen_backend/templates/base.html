{% load static %}

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Plateforme CESIZEN â€“ gestion RH pour vos projets CESI">
    <link rel="icon" href="{% static 'img/favicon.ico' %}" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <title>{% block title %}Mon Site{% endblock %}</title>
</head>

<body>

    <div class="d-flex flex-column justify-content-between full-vh bg">

        <header class="d-flex align-items-center justify-content-between w-100 px-4 py-4 shadow-bottom bg-light">
            <div class="d-flex align-items-center">
                <a href="{% url 'accueil' %}" class="btn {% if request.path == '/' %}blue-bg-color-selected{% else %}blue-bg-color{% endif %} btn-hover-b rounded-1 text-light me-4">Accueil</a>
                <a href="#exercices-content">Exercices</a>
            </div>

            <h1 class="m-0 position-absolute start-50 translate-middle-x d-none d-md-block">CESI ZEN</h1>

            <div id="user-zone" class="d-flex align-items-center"></div>
        </header>

        <main class="container">
            {% block content %}{% endblock %}
        </main>

        <footer class="text-center py-3 bg-light mt-auto shadow-top">
            <small>Â© 2025 CESIZEN â€“ Tous droits rÃ©servÃ©s</small>
        </footer>
    </div>

    <script type="module">
        import { fetchWithAuth, logout } from "{% static 'js/auth.js' %}";

        const userZone = document.getElementById("user-zone");

        async function renderUserHeader() {
            const access = localStorage.getItem("access");

            if (!access) {
                userZone.innerHTML = `
                    <a href="/connexion/" class="btn blue-bg-color btn-hover-b rounded-1 text-light me-4">Se connecter</a>
                    <a href="/inscription/" class="btn blue-bg-color btn-hover btn-hover-b rounded-1 text-light">S'inscrire</a>
                `;
                return;
            }

            try {
                const res = await fetchWithAuth("/api/profil/");
                if (!res.ok) throw new Error();

                const data = await res.json();
                const isAdmin = data.role === "administrateur" || data.is_superuser;

                userZone.innerHTML = `
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn blue-bg-color btn-hover-b text-light rounded-1" id="profil-btn">ðŸ‘¤ ${data.username}</button>
                        <a href="/profil/" class="btn btn-outline-secondary">Profil</a>
                        <a href="/preferences/" class="btn btn-outline-secondary">PrÃ©fÃ©rences</a>
                        ${isAdmin ? `<a href="/admin/" class="btn btn-outline-secondary">Back office</a>` : ""}
                        <button id="logout-btn" class="btn btn-danger btn-hover-r text-light">DÃ©connexion</button>
                    </div>
                `;

                document.getElementById("logout-btn").addEventListener("click", logout);
            } catch (err) {
                localStorage.clear();
                window.location.href = "/connexion/";
            }
        }

        document.addEventListener("DOMContentLoaded", renderUserHeader);
    </script>

</body>
</html>
